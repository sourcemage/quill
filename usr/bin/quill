//sgl/misc/quill/usr/bin/quill#8 - edit change 73413 (xtext)
#!/bin/bash
#---
## @Synopsis Spell creator script for SourceMage GNU/Linux
## @Copyright Copyright 2005 Andrew "ruskie" Levstik <ruskie@mages.ath.cx>
## @Copyright Copyright 2005 SourceMage GNU/Linux
## @License GPL v2
##
## @ToDo make substitute_url_variables go through /etc/sorcery/mirrors
## @ToDo put a multiversion option
## @ToDo make an option to edit all the existing files after generation
## @ToDo make configuring optional depends a must
## @ToDo add logic to quill to make it possible to use optional_depends single line or 
## @ToDo multiline depending on the length of line if <80 single else mutli
## @ToDo interface to add CONFIGURE options
## @ToDo automated bugcli submissions of spells
## @ToDo make a tar.bz2 of the spell immediately
## @ToDo automatic inclusion into a grimoire when finished
## @ToDo make it use the ~/.sourcemage dir for config
## @ToDo add cmdline options to make it possible to autoscript it
## @ToDo add a better configuration interface(dialog based I hope)
## @ToDo make it possible to also update spells using quill
## @ToDo make quill the be-all for spells
## @ToDo make quill interface with both sorcery and grimoire to get functions
##
## Asks the user in simple questions about generating a spell.
## @Globals BUILDISON, INSTALLISON, PREBUILDISON, TRIGGERSISON
## @Globals SPELL_HISTORY_NAME, SPELL_HISTORY_EMAIL, SPELL_NAME,
## @Globals SPELL_SRC_URL, SPELL_LICENSE, SPELL_URL, SPELL_SHORT_DESCRIPTION,
## @Globals SPELL_DESCRIPTION, SPELL_DEPENDENCIES, SPELL_OPTIONAL_DEPENDENCIES,
## @Globals SPELL_CONFLICTS, HISOTRY_DATE, SPELL_DATE, SPELL_SRC_FILE,
## @Globals SPELL_SANITIZED_FILE_NAME, SPELL_MD5_UNPACKED, SPELL_VERSION,
## @Globals CURRENTPWD, i, j, n, BUILD_DTFILE, DTFILE_MENUENTRY, DTFILE_EXEC
## @Globals DTFILE_MENUPATH, DTFILE_ICON, DTFILE_TERM, SPELL_SRC_DIR
##
## @Thanks BearPerson, dufflebunk, afrayedknot
## @Thanks To all testers
## @Contribution abouter
##
#---

#---
## @Synopsis md5_unpack function taken from md5unpack script
##
#---

#---
## Some basic stuff that should be loaded and set
. /etc/sorcery/config
QUILL_MODE="apprentice"
CURRENTPWD=$(pwd)

#---
## Not really a function it's supposed to parse the command line parameters
#---
while  [  -n  "$1"  ];  do
  if  echo  "" $1  |  grep  -q  "^ -";  then
    case  $1  in
                             --fmxml|-f) export QUILL_FMXML_MODE="on"; shift 1 ;;
                        --apprentice|-a) export QUILL_MODE="apprentice"; shift 1 ;;
                              --mage|-m) export QUILL_MODE="mage"; shift 1 ;;
                            --wizard|-w) export QUILL_MODE="wizard"; shift 1 ;;
           `echo $1 | grep "^--spell="`) SPELL_NAME=${1/"--spell="/""}; shift 1;;
      `echo $1 | grep "^--source_url="`) SPELL_SRC_URL=${1/"--source_url="/""}; shift 1;;
        `echo $1 | grep "^--web_site="`) SPELL_URL=${1/"--web_site="/""}; shift 1;;
         `echo $1 | grep "^--license="`) SPELL_LICENSE=${1/"--license="/""}; shift 1;;
           `echo $1 | grep "^--short="`) SPELL_SHORT_DESCRIPTION=${1/"--short="/""}; shift 1;;
                                     -h) quill_help
    esac
  else
    shift
  fi

QUILL_HOME_DIR=~/.sourcemage/quill
QUILL_QUILLRC=${QUILL_HOME_DIR}/quillrc
QUILL_OLD_QUILLRC=~/.quillrc
QUILL_SPELL_DIR=~/.sourcemage/spells
QUILL_TMP_DIR=~/.sourcemage/tmp

quill_rc
PROMPT_DELAY="4294967295"
BUILD_API=2
load_build_api
mkdir -p $QUILL_TMP_DIR

## Down to here... from here it's question and answer time
#---

#---
## Questions and stuff

quill_welcome

if [[ "${QUILL_FMXML_MODE}" == "on" ]]
then
  QUILL_FMXML_SPELL="$@"
  quill_fmxml_core
fi

query_spell_name
query_spell_source_url
query_spell_license
query_spell_url
query_spell_short_description
query_spell_description
query_spell_dependencies
query_spell_optional_dependencies
query_spell_build
query_spell_install
query_spell_desktop_file

if [[ "${QUILL_MODE}" == "mage" ]] || [[ "${QUILL_MODE}" == "wizard" ]]
then
query_spell_prepare
query_spell_conflicts
query_spell_configure
query_spell_provides
query_spell_final
query_spell_triggers
query_spell_solo
query_spell_configs
query_spell_volatiles
  if [[ "${QUILL_MODE}" == "wizard" ]]; then
  query_spell_pre_build
  query_spell_pre_install
  query_spell_post_install
  query_spell_pre_remove
  query_spell_post_remove
  query_spell_pre_resurrect
  query_spell_post_resurrect
  fi
fi


create_spell_base

if [[ "${SPELL_DEPENDENCIES}" != "" ]]
then
  add_dependencies
fi

if [[ "${SPELL_OPTIONAL_DEPENDENCIES}" != "" ]]
then
  add_optional_dependencies
fi

if [[ "${SPELL_CONFLICTS}" != "" ]]
then
  add_conflicts
fi

if [[ "${SPELL_PROVIDES}" != "" ]]
then
  add_provides
fi

parse_spell_source_file_info

show_spell_source_file_info

download_spell_source

substitute_url_variables

hunt_src_dir

add_details

if [[ "${PREPAREISON}" == "PREPARE, " ]]
then
  add_prepare
fi

if [[ "${CONFIGUREISON}" == "CONFIGURE, " ]]
then
  add_configure
fi

if [[ "${PREBUILDISON}" == "PRE_BUILD, " ]]
then
  add_pre_build
fi

if [[ "${BUILDISON}" == "BUILD, " ]]
then
  add_build
fi

if [[ "${INSTALLISON}" == "INSTALL, " ]]
then
  add_install
fi

if [[ "${POSTINSTALLISON}" == "POST_INSTALL, " ]]
then
  add_post_install
fi

if [[ "${TRIGGERSISON}" == "TRIGGERS, " ]]
then
  add_triggers
fi

if [[ "${BUILD_DTFILE}" != "" ]]
then
  add_desktop_file
fi

add_history

cd ${CURRENTPWD}

#---                                                                                                                         
##                                                                                                                           
## This software is free software; you can redistribute it and/or modify                                                     
## it under the terms of the GNU General Public License as published by                                                      
## the Free Software Foundation; either version 2 of the License, or
## (at your option) any later version.                                                                                       
##                                                                                                                           
## This software is distributed in the hope that it will be useful,                                                          
## but WITHOUT ANY WARRANTY; without even the implied warranty of                                                            
## MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
## GNU General Public License for more details.                                                                              
##
## You should have received a copy of the GNU General Public License                                                         
## along with this software; if not, write to the Free Software                                                              
## Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA  02111-1307  USA                                                 
##                                                                                                                           
#---
